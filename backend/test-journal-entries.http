### ERP Accounting API Tests - Journal Entries & Fiscal Periods
### Use with REST Client extension in VS Code

@baseUrl = http://localhost:4000/api
@token = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJjMGMyNzg4Yi04YzJkLTQ3ZTctYjE1OC01YjVlOWNlMzZiMDUiLCJ0ZW5hbnRJZCI6ImU2NjI3ZWEzLTM3ODktNDc1Yy1hMTk4LTE2YjQ4ODU3ZmM1ZiIsImVtYWlsIjoiYWRtaW5AZXJwLmxvY2FsIiwiaWF0IjoxNzY4OTgwMjc5LCJleHAiOjE3Njk1ODUwNzl9.inWEDEXNPzhFvuyWH_j21qbe-CUNpaTJH_DMtB3JrGg
@companyId = c5f61904-b52b-4e97-a1a7-1164cd5556d2
@fiscalPeriodId = 72972222-c9e2-4d49-bd57-abd379a2c2a4
@journalEntryId = 1b440b14-a541-49f8-826f-b2fae4455228
@cashAccountId = 81a52190-afb4-4cc7-b693-8f710090a1d0
@revenueAccountId = 75999fc3-dce9-4799-b9c6-1a2a3127a4d3

### 1. Login to get token
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "tenantCode": "DEFAULT",
  "email": "admin@erp.local",
  "password": "Admin123!"
}

### 2. Initialize Fiscal Periods (creates 13 periods: 1 year + 12 months)
POST {{baseUrl}}/fiscal-periods/initialize
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "companyId": "{{companyId}}",
  "fiscalYearStart": 1
}

### 3. Get All Fiscal Periods
GET {{baseUrl}}/fiscal-periods?companyId={{companyId}}
Authorization: Bearer {{token}}

### 4. Get Open Fiscal Periods Only
GET {{baseUrl}}/fiscal-periods?companyId={{companyId}}&status=OPEN
Authorization: Bearer {{token}}

### 5. Get Single Fiscal Period
GET {{baseUrl}}/fiscal-periods/{{fiscalPeriodId}}
Authorization: Bearer {{token}}

### 6. Create Manual Journal Entry (Cash Sale)
POST {{baseUrl}}/journal-entries
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "companyId": "{{companyId}}",
  "entryDate": "2026-01-21",
  "entryType": "MANUAL",
  "reference": "INV-001",
  "description": "Cash sale to customer",
  "lines": [
    {
      "accountId": "{{cashAccountId}}",
      "debit": 1000,
      "credit": 0,
      "description": "Cash received"
    },
    {
      "accountId": "{{revenueAccountId}}",
      "debit": 0,
      "credit": 1000,
      "description": "Sales revenue"
    }
  ]
}

### 7. Create Journal Entry with Multiple Lines
POST {{baseUrl}}/journal-entries
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "companyId": "{{companyId}}",
  "entryDate": "2026-01-21",
  "entryType": "MANUAL",
  "reference": "PAY-001",
  "description": "Payment of expenses",
  "lines": [
    {
      "accountId": "ae9d24ed-3000-45d7-89f3-70407891db26",
      "debit": 5000,
      "credit": 0,
      "description": "Office rent"
    },
    {
      "accountId": "9a73c789-bb21-4f27-8f89-18f749e2db20",
      "debit": 1500,
      "credit": 0,
      "description": "Electricity and water"
    },
    {
      "accountId": "{{cashAccountId}}",
      "debit": 0,
      "credit": 6500,
      "description": "Cash payment"
    }
  ]
}

### 8. Get All Journal Entries
GET {{baseUrl}}/journal-entries?companyId={{companyId}}
Authorization: Bearer {{token}}

### 9. Get Draft Journal Entries Only
GET {{baseUrl}}/journal-entries?companyId={{companyId}}&status=DRAFT
Authorization: Bearer {{token}}

### 10. Get Posted Journal Entries Only
GET {{baseUrl}}/journal-entries?companyId={{companyId}}&status=POSTED
Authorization: Bearer {{token}}

### 11. Get Journal Entries by Date Range
GET {{baseUrl}}/journal-entries?companyId={{companyId}}&startDate=2026-01-01&endDate=2026-01-31
Authorization: Bearer {{token}}

### 12. Get Journal Entries by Fiscal Period
GET {{baseUrl}}/journal-entries?companyId={{companyId}}&fiscalPeriodId={{fiscalPeriodId}}
Authorization: Bearer {{token}}

### 13. Get Single Journal Entry
GET {{baseUrl}}/journal-entries/{{journalEntryId}}
Authorization: Bearer {{token}}

### 14. Update Draft Journal Entry
PATCH {{baseUrl}}/journal-entries/{{journalEntryId}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "description": "Updated description - Cash sale to customer ABC",
  "reference": "INV-001-UPDATED"
}

### 15. Update Journal Entry Lines (Complete Replacement)
PATCH {{baseUrl}}/journal-entries/{{journalEntryId}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "lines": [
    {
      "accountId": "{{cashAccountId}}",
      "debit": 1200,
      "credit": 0,
      "description": "Cash received - updated amount"
    },
    {
      "accountId": "{{revenueAccountId}}",
      "debit": 0,
      "credit": 1200,
      "description": "Sales revenue - updated amount"
    }
  ]
}

### 16. Post Journal Entry (Make it permanent)
POST {{baseUrl}}/journal-entries/{{journalEntryId}}/post
Authorization: Bearer {{token}}

### 17. Reverse Posted Journal Entry
POST {{baseUrl}}/journal-entries/{{journalEntryId}}/reverse
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "reversalDate": "2026-01-22",
  "description": "Reversal due to error in original entry"
}

### 18. Delete Draft Journal Entry
DELETE {{baseUrl}}/journal-entries/{{journalEntryId}}
Authorization: Bearer {{token}}

### 19. Close Fiscal Period
POST {{baseUrl}}/fiscal-periods/{{fiscalPeriodId}}/close
Authorization: Bearer {{token}}

### 20. Reopen Fiscal Period
POST {{baseUrl}}/fiscal-periods/{{fiscalPeriodId}}/reopen
Authorization: Bearer {{token}}

### 21. Test Validation: Unbalanced Entry (Should Fail)
POST {{baseUrl}}/journal-entries
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "companyId": "{{companyId}}",
  "entryDate": "2026-01-21",
  "description": "This should fail - unbalanced",
  "lines": [
    {
      "accountId": "{{cashAccountId}}",
      "debit": 1000,
      "credit": 0
    },
    {
      "accountId": "{{revenueAccountId}}",
      "debit": 0,
      "credit": 500
    }
  ]
}

### 22. Test Validation: Less than 2 Lines (Should Fail)
POST {{baseUrl}}/journal-entries
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "companyId": "{{companyId}}",
  "entryDate": "2026-01-21",
  "description": "This should fail - only 1 line",
  "lines": [
    {
      "accountId": "{{cashAccountId}}",
      "debit": 1000,
      "credit": 0
    }
  ]
}

### 23. Test Validation: Both Debit and Credit (Should Fail)
POST {{baseUrl}}/journal-entries
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "companyId": "{{companyId}}",
  "entryDate": "2026-01-21",
  "description": "This should fail - line has both debit and credit",
  "lines": [
    {
      "accountId": "{{cashAccountId}}",
      "debit": 1000,
      "credit": 1000
    },
    {
      "accountId": "{{revenueAccountId}}",
      "debit": 0,
      "credit": 0
    }
  ]
}

### 24. Test: Post to Closed Period (Should Fail)
# First close the period using endpoint #19, then try to create entry in that period
POST {{baseUrl}}/journal-entries
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "companyId": "{{companyId}}",
  "entryDate": "2026-01-15",
  "description": "This should fail if period is closed",
  "lines": [
    {
      "accountId": "{{cashAccountId}}",
      "debit": 100,
      "credit": 0
    },
    {
      "accountId": "{{revenueAccountId}}",
      "debit": 0,
      "credit": 100
    }
  ]
}

### 25. Example: Complete Workflow
# Step 1: Create draft entry
# Step 2: Review and update if needed
# Step 3: Post the entry
# Step 4: If error found, reverse it
# Step 5: Create correcting entry
